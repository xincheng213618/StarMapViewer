# StarMapViewer

一个基于 WPF (.NET 8) 的多级瓦片星图浏览器示例，支持平滑缩放、平移、按需加载与 LRU 缓存，并通过设备像素对齐避免缩放时出现瓦片缝隙闪白。

## 功能特性
- 多级瓦片 (0 .. MaxZoomLevel) 动态选择：根据当前缩放倍率自动匹配最佳瓦片级别
- 增量按需加载：仅加载当前视口附近可见瓦片，并在视口移动后回收不需要的瓦片
- LRU 内存缓存：限制缓存容量 (默认 512) ，避免内存无限增长
- 设备像素对齐：缩放/平移时对瓦片边界做 DPI 级对齐，消除白色闪烁缝隙
- 平滑缩放中心锚定：以鼠标指针为中心进行缩放，保持视觉焦点稳定
- 居中自适应：初次加载或窗口尺寸变化时自动适配全图
- 调试信息：实时显示当前层级、加载瓦片数量、视口中心的世界坐标及覆盖瓦片编号

## 目录结构
```
./StarMapViewer.sln
./StarMapViewer/StarMapViewer.csproj
./StarMapViewer/MainWindow.xaml
./StarMapViewer/MainWindow.xaml.cs
./tiles/{zoom}/{x}_{y}.jpg
```
示例：`tiles/0/0_0.jpg` 为第 0 级 (基准级) 的整幅星图（切成 1x1）。更高 zoom 级别按 2^zoom 拆分为网格：
- 级别 0: 1 x 1
- 级别 1: 2 x 2
- 级别 2: 4 x 4
- 级别 N: (2^N) x (2^N)

每张瓦片文件命名：`x_y.jpg`，x 为列索引，y 为行索引，从左上角 (0,0) 开始。

## 瓦片准备说明
1. 先准备一张完整原始大图（作为 0 级）
2. 按级别逐级切片（可用 Python / GDAL / 自行编写工具）
3. 生成目录结构 `tiles/<zoom>/<x>_<y>.jpg`
4. 确保 0 级的 `0_0.jpg` 可正确读取（程序以其尺寸作为世界大小）

## 交互方式
| 操作          | 功能            |
|---------------|-----------------|
| 鼠标滚轮      | 缩放（指针为锚）|
| 左键按住拖动  | 平移视图        |

缩放被限制在 `[FitScale, 1.0]` 之间，`FitScale` 为初始完整显示全图所需比例。

## 缩放与层级选择逻辑
```
relative = scale / fitScale
zoom = floor(log2(relative))  (裁剪到 0..MaxZoomLevel)
```
当放大到原图 1x（或更高，受 MaxScale 限制）时使用最高可用级别；缩小时逐级退化。

## 关键实现要点
- 视图 -> 世界坐标换算使用 `_offset` + `_scale`
- 可见瓦片范围通过当前视口四角逆变换后取整并向外扩一圈冗余
- 每 5 帧节流一次瓦片增删，减少频繁 UI 改变
- `_transformDirty` 与 `_tilesDirty` 分离：仅位置/尺寸变化时复用现有控件，避免过度重建
- `PlaceTile` 使用 DPI 信息对四条边界做 Round，保证拼接严密

## 构建与运行
1. 使用 Visual Studio 2022 或 `dotnet` SDK 8.0+
2. 还原 / 构建
   ```bash
   dotnet build
   ```
3. 运行（或直接 F5）
4. 确保 `TilesRoot` 常量指向实际瓦片根目录

## 性能建议
- 大图可先离线生成多级瓦片，避免运行期裁切
- 适当调整 `CacheCapacity` 以平衡内存与命中率
- 如需更高缩放平滑度，可改用 `BitmapScalingMode.LowQuality` 或 `Fant`（但会增加模糊或开销）
- 大量瓦片时可考虑改为虚拟化/分层绘制（例如 DrawingVisual 复用）

## 常见问题
| 问题 | 说明 / 解决 |
|------|-------------|
| 缩放出现白色缝隙 | 确认使用当前版本，已通过设备像素对齐修复 |
| 不加载瓦片 | 检查 `TilesRoot` 路径与文件存在性；确保 0 级 `0_0.jpg` 可读取 |
| 缩放层级不变化 | 放大倍率尚未超过下一层级阈值 (2^n) 或达到 `MaxZoomLevel` |

## 后续可扩展方向
- 异步后台加载 + 低清晰度占位符
- 瓦片多线程解码队列
- 瓦片热点/标注叠加层
- GPU 加速（WriteableBitmap/Direct2D/Win2D）
- 动画惯性平移 / 缩放平滑过渡

## 许可证
示例代码可按个人或内部项目自由使用；如需公开发布请自行补充许可证文本。

---
如需添加功能（标注、搜索、裁剪、导出等）可继续提出需求。
